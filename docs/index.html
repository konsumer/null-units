<html>
  <head>
    <title>null-units</title>
    <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/10213618" />
    <style>
      body {
        font-family: sans-serif;
      }
      fieldset * {
        display: block;
      }
      fieldset label {
        display: inline-block;
        user-select: none;
      }
    </style>
  </head>
  <body>
    <p>Click to start</p>
  </body>
<script type="module">
import NullManager from './null-manager.js'

// I just like the Persian-scale
function getRandomPersianNote(baseNote=60, octaveRange = 2) {
    const persianScale = [0, 1, 4, 5, 6, 8, 11];

    // Create an expanded scale across multiple octaves
    const expandedScale = [];
    for (let octave = 0; octave < octaveRange; octave++) {
        persianScale.forEach(interval => {
            expandedScale.push(interval + (octave * 12));
        });
    }
    const randomIndex = Math.floor(Math.random() * expandedScale.length);
    return baseNote + expandedScale[randomIndex];
}

// click to play
async function oneTimeClick() {
  document.removeEventListener('click', oneTimeClick)
  document.body.innerHTML = ''

  const units = new NullManager()

  const outID = 0
  const scopeID = units.scopeNode()
  const wavescopeID = units.scopeNode()
  const pitchID = units.pitchNode()
  const wavetableID = await units.load("wavetable")
  const lpfID = await units.load("lpf")

  // set initial settings
  units.set_param(wavescopeID, "lineColor", 'blue')
  units.set_param(wavetableID, "type", 0) // sine
  units.set_param(wavetableID, "note", 60) // middle-C
  units.set_param(lpfID, "cutoff", 22)

  // for UI: set nicer names
  units.set_title(wavetableID, 'WASM: Wave Table')
  units.set_title(lpfID, 'WASM: Lowpass Filter')
  units.set_title(scopeID, 'Sound (from lowpass/audio)')
  units.set_title(wavescopeID, 'Wave Table Output')

  // make UI
  document.body.appendChild(units.genui(wavetableID))
  document.body.appendChild(units.genui(wavescopeID))
  document.body.appendChild(units.genui(lpfID))
  document.body.appendChild(units.genui(scopeID))
  document.body.appendChild(units.genui(pitchID))

  // connect things
  units.connect(wavetableID, 0, lpfID, 0)
  units.connect(wavetableID, 0, wavescopeID, 0)
  units.connect(lpfID, 0, scopeID, 0)
  units.connect(lpfID, 0, pitchID, 0)
  units.connect(lpfID, 0, outID, 0)

  // random notes/types
  setInterval(() => {
    units.set_param(wavetableID, "note", getRandomPersianNote(36, 1))
  }, 1000)
  setInterval(() => {
    units.set_param(wavetableID, "type", (Math.random() * 3))
  }, 250)
}

// click to play
document.addEventListener('click', oneTimeClick)
</script>
</html>
