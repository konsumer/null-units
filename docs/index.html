<html>
  <head>
    <title>null-units</title>
    <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/10213618" />
    <style>
    label {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    canvas {
      width: 100px;
    }
    </style>

  </head>
  <body>
    <p>
    Click to start. This loads a single sampler unit which has access to these waves:
    </p>

    <form id="ui">

    <label>
      <input type="radio" name="wave" value="0" checked/>
      <div>sin</div>
      <canvas width="256" height="100"></canvas>
    </label>

    <label>
      <input type="radio" name="wave" value="1"/>
      <div>sqr</div>
      <canvas width="256" height="100"></canvas>
    </label>

    <label>
      <input type="radio" name="wave" value="2"/>
      <div>tri</div>
      <canvas width="256" height="100"></canvas>
    </label>

    <label>
      <input type="radio" name="wave" value="3"/>
      <div>saw</div>
      <canvas width="256" height="100"></canvas>
    </label>

    <label>
      <input type="range" min="0" max="2000" value="440" name="freq" id="freq" />
      <div id="freq_output">440</div>
    </label>


    <p>Currently this is just reference, since my nodes are not outputting anything:</p>
    <canvas id="oscope"></canvas>

    </form>

  </body>
  <script type="module">
  import NullUnit from './NullUnit.js'
  import Oscilloscope from './Oscilloscope.js'

  // this is UI stuff
  // get all samples from unit-worker and show them
  // send params when they change

  function drawWave(canvas, data) {
    if (!canvas?.getContext) {
      return
    }
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const middleY = height / 2;
    ctx.clearRect(0, 0, width, height);
    ctx.beginPath();
    ctx.strokeStyle = '#999';
    ctx.lineWidth = 1;
    ctx.moveTo(0, middleY);
    ctx.lineTo(width, middleY);
    ctx.stroke();

    ctx.beginPath();
    ctx.strokeStyle = '#f00';
    ctx.lineWidth = 2;
    const yScale = height / 2;
    for (let i = 0; i < data.length; i++) {
      const x = i;
      const y = middleY - (data[i] * yScale);
      if (i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    }
    ctx.stroke();
  }

  // this is basic setup of the frame of things


  async function oneTimeClick() {
    document.removeEventListener('click', oneTimeClick)
    const context = new AudioContext();
    const samplerExample = new NullUnit(context)
    await samplerExample.load('sampler')
    console.log('unit loaded', samplerExample.info)
    samplerExample.connect(context.destination)

    const canvases = [...document.querySelectorAll('canvas')]
    const oscope = canvases.pop()
    for (const c in canvases) {
      drawWave(canvases[c], await samplerExample.getSample(c))
    }

    const oscilloscope = new Oscilloscope(oscope);
    // oscilloscope.init(context, samplerExample.audioWorkletNode)

    // example that uses audio-api oscillator instead
    const oscillator = context.createOscillator()
    oscillator.type = "sine"
    oscillator.frequency.setValueAtTime(440, context.currentTime)
    // oscillator.connect(context.destination)
    oscillator.start()
    oscilloscope.init(context, oscillator)


    const form = document.getElementById('ui')
    const freq_out = document.getElementById('freq_output')
    form.addEventListener('change', (e) => {
      if (e.target.name === 'freq') {
        samplerExample.setParam('pitch', form.freq.value)

        if (typeof oscillator !== 'undefined') {
          oscillator.frequency.setValueAtTime(form.freq.value, context.currentTime)
        }
      }
      if (e.target.name === 'wave') {
        samplerExample.setParam('sample ID', form.wave.value)

        if (typeof oscillator !== 'undefined') {
          if (form.wave.value == 0) {
            oscillator.type = "sine"
          }
          if (form.wave.value == 1) {
            oscillator.type = "square"
          }
          if (form.wave.value == 2) {
            oscillator.type = "triangle"
          }
          if (form.wave.value == 3) {
            oscillator.type = "sawtooth"
          }
          console.log(oscillator.type)
        }
      }
      freq_out.innerHTML = form.freq.value
    })
  }

  document.addEventListener('click', oneTimeClick)

  </script>
</html>
