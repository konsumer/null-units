<html>
  <head>
    <title>null-units</title>
    <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/10213618" />
    <link rel="stylesheet" href="demo.css">
  </head>
  <body>
    <p>Click to start</p>
  </body>
  <script type="module">
    import NullManager from './null-manager.js'

    // I just like the Persian-scale
    function getRandomPersianNote(baseNote = 60, octaveRange = 2) {
      const persianScale = [0, 1, 4, 5, 6, 8, 11]
      const expandedScale = []
      for (let octave = 0; octave < octaveRange; octave++) {
        persianScale.forEach((interval) => {
          expandedScale.push(interval + octave * 12)
        })
      }
      const randomIndex = Math.floor(Math.random() * expandedScale.length)
      return baseNote + expandedScale[randomIndex]
    }

    // click to play
    async function oneTimeClick() {
      document.removeEventListener('click', oneTimeClick)
      document.body.innerHTML = ''

      const units = new NullManager()
      const audioOut = 0

      // load some units
      const osc = await units.load('wavetable')
      const gainOsc = await units.load('gain')
      const scopeOsc = await units.load('scope')
      const pitch = await units.load('pitch')
      const lpf = await units.load('mooglpf')
      const echo = await units.load('bbd')
      const tr808 = await units.load('tr808')
      const crush = await units.load('bitcrusher')
      const scopeMain = await units.load('scope')

      // set initial value
      units.set_param(gainOsc, 'gain', 20)
      units.set_param(osc, 'type', 3)
      units.set_param(lpf, 'cutoff', 88)
      units.set_param(lpf, 'resonance', 0.8)
      units.set_param(echo, 'time', 1000)
      units.set_param(echo, 'feedback', 85)
      units.set_param(echo, 'dirt', 25)
      units.set_param(crush, 'bits', 3.4)
      units.set_param(crush, 'rate', 0.8)
      units.set_param(crush, 'noise', 0)
      units.set_param(crush, 'mix', 0.4)


      // connect units
      // use source for analysis (better results)
      units.connect(osc, scopeOsc)
      units.connect(osc, pitch)

      units.connect(osc, lpf)
      units.connect(lpf, echo)
      units.connect(echo, gainOsc)
      units.connect(gainOsc, audioOut)
      units.connect(gainOsc, scopeMain)

      units.connect(tr808, scopeMain)
      units.connect(tr808, crush)
      units.connect(crush, audioOut)


      // create UI
      units.setTitle(scopeOsc, 'Source')
      units.setTitle(scopeMain, 'Final')
      document.body.appendChild(units.ui())

      // update UI when manager gets a chance
      requestAnimationFrame(() => units.update())

      // play random persian-scale song
      setInterval(() => {
        units.set_param(osc, 'note', getRandomPersianNote(60, 1))
      }, 800)

      // move LPF cutoff to make things trippy
      let i = 0
      setInterval(() => {
        units.set_param(lpf, 'cutoff', 36 + (i++ % 36))
      }, 200)

      // drum beat
      setInterval(() => {
        setTimeout(() => units.set_param(tr808, 'note', 38), 500) // SD
        units.set_param(tr808, 'note', 35) // BD
      }, 1000)
      setTimeout(() => {
        setInterval(() => {
          units.set_param(tr808, 'note', 42) // CH
        }, 500)
      }, 250)
    }

    // click to play
    document.addEventListener('click', oneTimeClick)
  </script>
</html>
