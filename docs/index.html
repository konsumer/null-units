<html>
  <head>
    <title>null-units</title>
    <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/10213618" />
    <style>
    body {
      font-family: sans-serif;
    }
    label {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    label canvas {
      width: 100px;
    }
    label > div {
      width: 30px;
    }
    </style>

  </head>
  <body>
    <p>
    Click to start. This loads a single sampler unit which has access to these waves:
    </p>

    <form id="ui">
      <h3>OSC</h3>

      <label>
        <input type="radio" name="wave" value="0" checked/>
        <div>sin</div>
        <canvas width="256" height="100"></canvas>
      </label>

      <label>
        <input type="radio" name="wave" value="1"/>
        <div>sqr</div>
        <canvas width="256" height="100"></canvas>
      </label>

      <label>
        <input type="radio" name="wave" value="2"/>
        <div>tri</div>
        <canvas width="256" height="100"></canvas>
      </label>

      <label>
        <input type="radio" name="wave" value="3"/>
        <div>saw</div>
        <canvas width="256" height="100"></canvas>
      </label>

      <label>
        <div>freq</div>
        <input type="range" min="0" max="2000" value="440" name="freq" id="freq" />
        <div id="freq_output">440</div>
      </label>

      <h3>LPF</h3>

      <label>
        <div>gain</div>
        <input type="range" min="0" max="100" value="100" name="gain" id="gain" />
        <div id="gain_output">100</div>
      </label>

      <label>
        <div>cut</div>
        <input type="range" min="0" max="2000" value="460" name="cutoff" id="cutoff" />
        <div id="cutoff_output">460</div>
      </label>

      <label>
        <div>reso</div>
        <input type="range" min="0" max="100" value="100" name="reso" id="reso" />
        <div id="reso_output">100</div>
      </label>

      <canvas id="oscope"></canvas>

    </form>

  </body>
  <script type="module">
  import NullUnit from './NullUnit.js'
  import Oscilloscope from './Oscilloscope.js'

  // this is UI stuff
  // get all samples from unit-worker and show them
  // send params when they change

  function drawWave(canvas, data) {
    if (!canvas?.getContext) {
      return
    }
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const middleY = height / 2;
    ctx.clearRect(0, 0, width, height);
    ctx.beginPath();
    ctx.strokeStyle = '#999';
    ctx.lineWidth = 1;
    ctx.moveTo(0, middleY);
    ctx.lineTo(width, middleY);
    ctx.stroke();

    ctx.beginPath();
    ctx.strokeStyle = '#f00';
    ctx.lineWidth = 2;
    const yScale = height / 2;
    for (let i = 0; i < data.length; i++) {
      const x = i;
      const y = middleY - (data[i] * yScale);
      if (i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    }
    ctx.stroke();
  }

  // this is basic setup of the frame of things


  async function oneTimeClick() {
    document.removeEventListener('click', oneTimeClick)
    const context = new AudioContext();

    const samplerExample = new NullUnit(context)
    await samplerExample.load('sampler')

    const lpfExample = new NullUnit(context)
    await lpfExample.load('lpf')


    // [sampler] -> [lpf] -> [out]
    samplerExample.connect(lpfExample.input)
    lpfExample.connect(context.destination)

    // set intial values
    samplerExample.setParam('pitch', 440)
    samplerExample.setParam('sample', 0)
    lpfExample.setParam('gain', 100)
    lpfExample.setParam('cutoff', 460)
    lpfExample.setParam('resonance', 100)

    const canvases = [...document.querySelectorAll('canvas')]
    const oscope = canvases.pop()
    for (const c in canvases) {
      drawWave(canvases[c], await samplerExample.getSample(c))
    }

    const oscilloscope = new Oscilloscope(oscope);
    oscilloscope.init(context, lpfExample.input)

    const form = document.getElementById('ui')
    const freq_out = document.getElementById('freq_output')
    const gain_out = document.getElementById('gain_output')
    const cutoff_out = document.getElementById('cutoff_output')
    const reso_out = document.getElementById('reso_output')

    form.addEventListener('change', (e) => {
      if (e.target.name === 'gain') {
        lpfExample.setParam('gain', form.gain.value)
        gain_out.innerHTML = form.gain.value
      }
      if (e.target.name === 'cutoff') {
        lpfExample.setParam('cutoff', form.cutoff.value)
        cutoff_out.innerHTML = form.cutoff.value
      }
      if (e.target.name === 'reso') {
        lpfExample.setParam('resonance', form.reso.value)
        reso_out.innerHTML = form.reso.value
      }

      if (e.target.name === 'freq') {
        samplerExample.setParam('pitch', form.freq.value)
        freq_out.innerHTML = form.freq.value
      }
      if (e.target.name === 'wave') {
        samplerExample.setParam('sample', form.wave.value)
      }
    })
  }

  document.addEventListener('click', oneTimeClick)

  </script>
</html>
