<html>
  <head>
    <title>null-units</title>
    <link rel="icon" type="image/x-icon" href="https://avatars.githubusercontent.com/u/10213618" />
    <style>
    label {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    canvas {
      width: 100px;
    }
    </style>

  </head>
  <body>

    <p>
    This loads a single sampler unit which has access to these waves:
    </p>

    <form id="ui">

    <label>
      <input type="radio" name="wave" value="0" checked/>
      <div>sin</div>
      <canvas width="256" height="100"></canvas>
    </label>

    <label>
      <input type="radio" name="wave" value="1"/>
      <div>sqr</div>
      <canvas width="256" height="100"></canvas>
    </label>

    <label>
      <input type="radio" name="wave" value="2"/>
      <div>tri</div>
      <canvas width="256" height="100"></canvas>
    </label>

    <label>
      <input type="radio" name="wave" value="3"/>
      <div>saw</div>
      <canvas width="256" height="100"></canvas>
    </label>

    <label>
      <input type="range" min="0" max="12544" value="440" name="freq" id="freq" />
      <div id="freq_output">440</div>
    </label>

    <canvas id="oscope"></canvas>

    </form>

  </body>
  <script type="module">
  import NullUnit from './NullUnit.js'

  // this is basic setup of the frame of things
  const context = new AudioContext();
  await context.audioWorklet.addModule(`${import.meta.url}/unit-processor.js`)

  document.addEventListener('click', () => {
    if (context.state === "suspended") {
      context.resume()
      console.log('resumed')
    }
  })

  // this is UI stuff
  // get all samples from unit-worker and show them
  // send params when they change

  function drawWave(canvas, data) {
    if (!canvas?.getContext) {
      return
    }
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const middleY = height / 2;
    ctx.clearRect(0, 0, width, height);
    ctx.beginPath();
    ctx.strokeStyle = '#999';
    ctx.lineWidth = 1;
    ctx.moveTo(0, middleY);
    ctx.lineTo(width, middleY);
    ctx.stroke();

    ctx.beginPath();
    ctx.strokeStyle = '#f00';
    ctx.lineWidth = 2;
    const yScale = height / 2;
    for (let i = 0; i < data.length; i++) {
      const x = i;
      const y = middleY - (data[i] * yScale);
      if (i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    }
    ctx.stroke();
  }

  const samplerExample = new NullUnit(context)
  await samplerExample.load('sampler')
  console.log('unit loaded', samplerExample.info)
  samplerExample.connect(context.destination)

  const canvases = [...document.querySelectorAll('canvas')]
  const oscope = canvases.pop()
  for (const c in canvases) {
    drawWave(canvases[c], await samplerExample.getSample(c))
  }

  const form = document.getElementById('ui')
  const freq_out = document.getElementById('freq_output')
  form.addEventListener('change', (e) => {
    if (e.target.name === 'freq') {
      samplerExample.setParam('pitch', form.freq.value)
    }
    if (e.target.name === 'wave') {
      samplerExample.setParam('sample ID', form.wave.value)
    }
    freq_out.innerHTML = form.freq.value
  })

  </script>
</html>
